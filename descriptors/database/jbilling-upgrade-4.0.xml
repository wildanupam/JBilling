<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet author="Emir Calabuch" context="base" id="add diameter entities">
        <comment>Tables used for managing charge sessions and reservations</comment>
        <createTable tableName="charge_sessions">
            <column name="id" type="java.sql.Types.INTEGER" />
            <column name="user_id" type="java.sql.Types.INTEGER" />
            <column name="session_token" type="java.sql.Types.VARCHAR(150)" />
            <column name="ts_started" type="java.sql.Types.TIMESTAMP" />
            <column name="ts_last_access" type="java.sql.Types.TIMESTAMP" />
        </createTable>

        <createTable tableName="reserved_amounts">
            <column name="id" type="java.sql.Types.INTEGER" />
            <column name="session_id" type="java.sql.Types.INTEGER" />
            <column name="ts_created" type="java.sql.Types.TIMESTAMP" />
            <column name="currency_id" type="java.sql.Types.INTEGER" />
            <column name="reserved_amount" type="java.sql.Types.NUMERIC(22,10)" />
            <column name="item_id" type="java.sql.Types.INTEGER" />
        </createTable>
    </changeSet>

    <changeSet author="Emir Calabuch" context="base" id="add diameter constraints">
        <addPrimaryKey tableName="charge_sessions" columnNames="id" />

        <addPrimaryKey tableName="reserved_amounts" columnNames="id" />

        <addForeignKeyConstraint constraintName="fk_reservations_session"
                                 baseTableName="reserved_amounts" baseColumnNames="session_id"
                                 referencedTableName="charge_sessions" referencedColumnNames="id" />

        <addForeignKeyConstraint constraintName="fk_sessions_user"
                                 baseTableName="charge_sessions" baseColumnNames="user_id"
                                 referencedTableName="base_user" referencedColumnNames="id" />
    </changeSet>

    <changeSet author="Sergio Liendo" context="base" id="#4184 - Implement 'Start Session' API call">

        <comment>Preference diameter destination realm</comment>
        <insert tableName="preference_type">
            <column name="id" valueComputed="(select max(p.id) + 1 from preference_type p)"/>
            <column name="def_value" value="realm"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="50"/>
            <column name="foreign_id" valueComputed="(select max(id) from preference_type)"/>
            <column name="psudo_column" value="description"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="Diameter Destination Realm"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="50"/>
            <column name="foreign_id" valueComputed="(select max(id) from preference_type)"/>
            <column name="psudo_column" value="instruction"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="The realm to be charged. This can be used for routing Diameter messages, so should match a locally-configured realm."/>
        </insert>

        <comment>Preference diameter quota threshold</comment>
        <insert tableName="preference_type">
            <column name="id" valueComputed="(select max(id) + 1 from preference_type p)"/>
            <column name="def_value" value="0"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="50"/>
            <column name="foreign_id" valueComputed="(select max(id) from preference_type)"/>
            <column name="psudo_column" value="description"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="Diameter Quota Threshold"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="50"/>
            <column name="foreign_id" valueComputed="(select max(id) from preference_type)"/>
            <column name="psudo_column" value="instruction"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="When this number of seconds remains the call handling unit should request re-authorisation."/>
        </insert>

        <comment>Preference diameter session grace period seconds</comment>
        <insert tableName="preference_type">
            <column name="id" valueComputed="(select max(id) + 1 from preference_type p)"/>
            <column name="def_value" value="0"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="50"/>
            <column name="foreign_id" valueComputed="(select max(id) from preference_type p)"/>
            <column name="psudo_column" value="description"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="Diameter Session Grace Period"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="50"/>
            <column name="foreign_id" valueComputed="(select max(id) from preference_type)"/>
            <column name="psudo_column" value="instruction"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="Number of seconds to wait before Diameter sessions are forcibly closed." />
        </insert>
    </changeSet>

    <changeSet id="add data column to reserved_amounts table" author="Oscar Bidabehere" context="base" dbms="postgresql,mysql">
        <addColumn tableName="reserved_amounts">
            <column name="data" type="TEXT"/>
        </addColumn>
    </changeSet>

    <changeSet id="add data column to reserved_amounts table" author="Emir Calabuch" context="base" dbms="oracle">
        <addColumn tableName="reserved_amounts">
            <column name="data" type="VARCHAR2(4000)"/>
        </addColumn>
    </changeSet>

    <changeSet id="add quantity column to reserved amounts table" author="Emir Calabuch" context="base">
        <addColumn tableName="reserved_amounts">
            <column name="quantity" type="java.sql.Types.NUMERIC(22,10)"></column>
        </addColumn>
    </changeSet>

    <changeSet id="add quantity multiplier" author="Emir Calabuch" context="base">
        <comment>Preference diameter unit multiplier/divisor</comment>
        <insert tableName="preference_type">
            <column name="id" valueComputed="(select max(id) + 1 from preference_type p)"/>
            <column name="def_value" value="1"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="50"/>
            <column name="foreign_id" valueComputed="(select max(id) from preference_type)"/>
            <column name="psudo_column" value="description"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="Diameter units multiplier/divisor"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="50"/>
            <column name="foreign_id" valueComputed="(select max(id) from preference_type)"/>
            <column name="psudo_column" value="instruction"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="The units value received from Diameter is divided/multiplied by this factor to convert input seconds to other time units. Values &lt; 1 set the multiplier to 1." />
        </insert>

    </changeSet>

    <changeSet id="Add 'Subscriber URI' metafield" author="Oscar Bidabehere" dbms="PostgreSql,MS-SQL,Oracle,MariaDB, MySQL">
        <preConditions onFail="CONTINUE">
            <and>
                <sqlCheck expectedResult="4">SELECT COUNT(*) FROM entity</sqlCheck>
            </and>
        </preConditions>

        <sql>
            <![CDATA[
                INSERT INTO meta_field_name (id, entity_id, name, entity_type, data_type, is_disabled, is_mandatory, display_order, optlock)
                select (select COALESCE(max(p.id),0)+1 from meta_field_name p) + (select COALESCE(count(*),0) from entity e2 where e1.id > e2.id and e2.id <> e1.id),
                       e1.id,
                       'Subscriber URI',
                       'CUSTOMER',
                       'STRING',
                       false,
                       false,
                       1,
                       1
                from entity e1
                order by e1.id
            ]]>
        </sql>
    </changeSet>
    
    <changeSet id="Add 'Subscriber URI' metafield" author="Oscar Bidabehere" dbms="hsqldb,h2">
        <preConditions onFail="CONTINUE">
            <and>
                <sqlCheck expectedResult="4">SELECT COUNT(*) FROM entity</sqlCheck>
            </and>
        </preConditions>

        <sql>
            <![CDATA[
                INSERT INTO meta_field_name (id, entity_id, name, entity_type, data_type, is_disabled, is_mandatory, display_order, optlock)
                select (select COALESCE(max(p.id),0)+1 from meta_field_name p) + (select COALESCE(count(*),0) from entity e2 where e1.id > e2.id and e2.id <> e1.id),
                       e1.id,
                       'Subscriber URI',
                       'CUSTOMER',
                       'STRING',
                       false,
                       false,
                       1,
                       1
                from entity e1
                order by e1.id
            ]]>
        </sql>
    </changeSet>

    <changeSet id="#4430 - Call details in order line item" author="Oscar Bidabehere" context="base">
        <addColumn tableName="order_line">
            <column name="sip_uri" type="java.sql.Types.VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="Requirements #4501 - Per-customer automatic top-up parameters" author="Oscar Bidabehere" context="base">
        <addColumn tableName="customer">
            <column name="recharge_threshold" type="java.sql.Types.NUMERIC(22,10)">
                <constraints nullable="true"/>
            </column>
            <column name="monthly_limit" type="java.sql.Types.NUMERIC(22,10)">
                <constraints nullable="true" />
            </column>
            <column name="current_monthly_amount" type="java.sql.Types.NUMERIC(22,10)">
                <constraints nullable="true" />
            </column>
            <column name="current_month" type="java.sql.Types.TIMESTAMP">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>


    <changeSet id="add carried_units column to charge_sessions table" author="Oscar bidabehere" context="base">
        <addColumn tableName="charge_sessions">
            <column name="carried_units" type="java.sql.Types.NUMERIC(22,10)"></column>
        </addColumn>
    </changeSet>

    <changeSet author="Rahul Asthana" context="base" id="20130510-#4989-customer-notes">
        <createTable tableName="customer_notes">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="note_title" type="varchar(50)"/>
            <column name="note_content" type="varchar(1000)"/>
            <column name="creation_time" type="timestamp"/>
            <column name="entity_id" type="java.sql.Types.INTEGER"/>
            <column name="user_id" type="java.sql.Types.INTEGER" />
            <column name="customer_id" type="java.sql.Types.INTEGER" />
        </createTable>
        <addForeignKeyConstraint constraintName="customer_notes_entity_id_FK"
                                 baseTableName="customer_notes" baseColumnNames="entity_id"
                                 referencedTableName="entity" referencedColumnNames="id"
                />
        <addForeignKeyConstraint constraintName="customer_notes_user_id_FK"
                                 baseTableName="customer_notes" baseColumnNames="user_id"
                                 referencedTableName="base_user" referencedColumnNames="id"
                />
        <addForeignKeyConstraint constraintName="customer_notes_customer_id_FK"
                                 baseTableName="customer_notes" baseColumnNames="customer_id"
                                 referencedTableName="customer" referencedColumnNames="id"
                />
        <dropColumn columnName="notes"  tableName="customer"/>
        <insert tableName="jbilling_seqs">
            <column name="name" value="customer_notes"/>
            <column name="next_id" valueNumeric="1"/>
        </insert>
    </changeSet>
    <changeSet author="Rahul Asthana" context="base" id="20130520-#4962-customer-notes">
        <dropColumn columnName="balance_type"  tableName="customer"/>
    </changeSet>

    <changeSet author="Panche Isajeski" context="base" id="20130820-add-rating-unit">
        <createTable tableName="rating_unit">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="price_unit_name" type="varchar(50)"/>
            <column name="increment_unit_name" type="varchar(50)"/>
            <column name="increment_unit_quantity" type="java.sql.Types.NUMERIC(22,10)"/>
            <column name="can_be_deleted" type="java.sql.Types.BOOLEAN" defaultValue="true"/>
            <column name="optlock" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="rating_unit_entity_id_FK"
                                 baseTableName="rating_unit" baseColumnNames="entity_id"
                                 referencedTableName="entity" referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="Panche Isajeski" context="base" id="20130820-default-rating-unit-rate-card">
        <!-- Time rating unit -->
        <sql>
            <![CDATA[
                insert into rating_unit
                    (id, name, entity_id, price_unit_name, increment_unit_name, increment_unit_quantity,
                    can_be_deleted, optlock)
                select (select COALESCE(max(r.id),0)+1 from rating_unit r) + (select count(*) from entity e2 where e1.id > e2.id and e2.id <> e1.id),
                'Time',e1.id,'Minute','Seconds',60.0,false,0
                from entity e1;
            ]]>
        </sql>

        <insert tableName="jbilling_seqs">
            <column name="name" value="rating_unit"/>
            <column name="next_id" valueComputed="(select COALESCE(max(r.id),0)+1 from rating_unit r)"/>
        </insert>

        <update tableName="jbilling_seqs">
            <column name="next_id" valueComputed="(select COALESCE(max(m.id),0)+1 from matching_field m)"/>
            <where>name='matching_field'</where>
        </update>

        <insert tableName="jbilling_seqs">
            <column name="name" value="route"/>
            <column name="next_id" valueComputed="(select COALESCE(max(r.id),0)+1 from route r)" />
        </insert>

    </changeSet>

    <changeSet author="Vladimir Carevski" context="base" id="hierarchical_routing">
        <addColumn tableName="route">
            <column name="root_table" type="java.sql.Types.BOOLEAN" defaultValueBoolean="false"/>
            <column name="output_field_name" type="java.sql.Types.VARCHAR(150)"/>
        </addColumn>
    </changeSet>

    <changeSet author="Gerhard Maree" context="base" id="20131024 hierarchical_routing - default_route">
        <addColumn tableName="route">
            <column name="default_route" type="java.sql.Types.VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="hierarchical_routing_matching_field_fix" author="Panche Isajeski" context="post_base">
        <update tableName="matching_field">
            <column name="type" value="EXACT"/>
            <where>type='ROUTE'</where>
        </update>
    </changeSet>

    <changeSet author="Vladimir Carevski" context="test" id="#7332-global-mediation-process-test" >

        <!-- active some currencies for Reseller company -->
        <insert tableName="currency_entity_map">
            <column name="currency_id" valueNumeric="2"/>
            <column name="entity_id" valueNumeric="3"/>
        </insert>
        <insert tableName="currency_entity_map">
            <column name="currency_id" valueNumeric="1"/>
            <column name="entity_id" valueNumeric="3"/>
        </insert>
        <insert tableName="currency_entity_map">
            <column name="currency_id" valueNumeric="3"/>
            <column name="entity_id" valueNumeric="3"/>
        </insert>
        <insert tableName="currency_entity_map">
            <column name="currency_id" valueNumeric="5"/>
            <column name="entity_id" valueNumeric="3"/>
        </insert>
       
        <!--Add global cateory, define product that is accesible to child.
            Define root price and child price for that product -->
        <insert tableName="item_type">
            <column name="id" valueNumeric="230300"/>
            <column name="entity_id" valueNumeric="1"/>
            <column name="description" value="Global Call Products"/>
            <column name="order_line_type_id" valueNumeric="1"/>
            <column name="optlock" valueNumeric="0"/>
            <column name="internal" valueBoolean="false"/>
            <column name="allow_asset_management" valueNumeric="0"/>
            <column name="asset_identifier_label" value=""/>
            <column name="parent_id"/>
            <column name="global" valueBoolean="true"/>
        </insert>

        <insert tableName="item">
            <column name="id" valueNumeric="320100"/>
            <column name="internal_number" value="GL-CALL-1"/>
            <column name="entity_id" valueNumeric="1"/>
            <column name="percentage"/>
            <column name="deleted" valueNumeric="0"/>
            <column name="has_decimals" valueNumeric="0"/>
            <column name="optlock" valueNumeric="2"/>
            <column name="gl_code" value=""/>
            <column name="asset_management_enabled" valueNumeric="0"/>
            <column name="standard_availability" valueBoolean="true"/>
            <column name="global" valueBoolean="true"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="14"/>
            <column name="foreign_id" valueNumeric="320100"/>
            <column name="psudo_column" value="description"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="CALL 1"/>
        </insert>

        <insert tableName="item_type_map">
            <column name="item_id" valueNumeric="320100"/>
            <column name="type_id" valueNumeric="230300"/>
        </insert>

        <!-- configure that the child company will generate charges into one order -->
        <insert tableName="preference">
            <column name="id" valueComputed="(select max(p.id)+1 from preference p)"/>
            <column name="type_id" valueNumeric="41" />
            <column name="table_id" valueNumeric="5" />
            <column name="foreign_id" valueNumeric="3" />
            <column name="value" value = "1"/>
        </insert>
        
        <update tableName="jbilling_seqs">
            <column name="next_id" valueComputed="(select max(p.id)+1 from item_type p)"/>
            <where>name='item_type'</where>
        </update>
        <update tableName="jbilling_seqs">
            <column name="next_id" valueComputed="(select max(p.id)+1 from item p)"/>
            <where>name='item'</where>
        </update>
        <update tableName="jbilling_seqs">
            <column name="next_id" valueComputed="(select max(p.id)+1 from preference p)"/>
            <where>name='preference'</where>
        </update>
    </changeSet>

    <changeSet author="Alexander Aksenov" context="base" id="20140220 #7520 - Order Changes Type">
        <createTable tableName="order_change_type">
            <column name="id" type="java.sql.Types.INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="order_change_type_pkey"/>
            </column>
            <column name="name" type="java.sql.Types.VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="java.sql.Types.INTEGER" />
            <column name="default_type" type="java.sql.Types.Boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="allow_order_status_change" type="java.sql.Types.Boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="optlock" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="entity_id"
                                 baseTableName="order_change_type"
                                 constraintName="order_change_type_entity_id_fk"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="entity"
                                 referencesUniqueColumn="false"/>

        <insert tableName="jbilling_table">
            <column name="id" valueComputed="(select max(t.id)+1 from jbilling_table t)"/>
            <column name="name" value="order_change_type"/>
        </insert>
        <insert tableName="jbilling_seqs">
            <column name="name" value="order_change_type"/>
            <column name="next_id" valueNumeric="2"/>
        </insert>

        <createTable tableName="order_change_type_item_type_map">
            <column name="order_change_type_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="item_type_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="order_change_type_id"
                                 baseTableName="order_change_type_item_type_map"
                                 constraintName="order_change_type_item_type_map_change_type_id_fk"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_change_type"
                                 referencesUniqueColumn="false"/>
        <addForeignKeyConstraint baseColumnNames="item_type_id"
                                 baseTableName="order_change_type_item_type_map"
                                 constraintName="order_change_type_item_type_map_item_type_id_fk"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="item_type"
                                 referencesUniqueColumn="false"/>

        <createTable tableName="order_change_type_meta_field_map">
            <column name="order_change_type_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="meta_field_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="order_change_type_id"
                                 baseTableName="order_change_type_meta_field_map"
                                 constraintName="order_change_type_meta_field_map_change_type_id_fk"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_change_type"
                                 referencesUniqueColumn="false"/>
        <addForeignKeyConstraint baseColumnNames="meta_field_id"
                                 baseTableName="order_change_type_meta_field_map"
                                 constraintName="order_change_type_meta_field_map_meta_field_id_fk"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meta_field_name"
                                 referencesUniqueColumn="false"/>
        <insert tableName="order_change_type">
            <column name="id" type="java.sql.Types.INTEGER" valueNumeric="1"/>
            <column name="name" type="java.sql.Types.VARCHAR(255)" value="Default"/>
            <column name="optlock" type="java.sql.Types.INTEGER" valueNumeric="0"/>
            <column name="default_type" type="java.sql.Types.Boolean" valueBoolean="true"/>
            <column name="allow_order_status_change" type="java.sql.Types.Boolean" valueBoolean="false"/>
        </insert>

        <addColumn tableName="order_change">
            <column name="order_change_type_id" type="java.sql.Types.INTEGER"/>
        </addColumn>
        <addColumn tableName="order_change">
            <column name="order_status_id" type="java.sql.Types.INTEGER"/>
        </addColumn>

        <update tableName="order_change">
            <column name="order_change_type_id" valueNumeric="1"/>
        </update>

        <addNotNullConstraint tableName="order_change" columnDataType="java.sql.Types.INTEGER" columnName="order_change_type_id"/>

        <addForeignKeyConstraint baseColumnNames="order_change_type_id"
                                 baseTableName="order_change"
                                 constraintName="order_change_order_change_type_id_fk"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_change_type"
                                 referencesUniqueColumn="false"/>

        <addForeignKeyConstraint baseColumnNames="order_status_id"
                                 baseTableName="order_change"
                                 constraintName="order_change_order_status_id_fk"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_status"
                                 referencesUniqueColumn="false"/>

    </changeSet>

    <changeSet author="Alexander Aksenov" context="test" id="20140220 #7520 - Order Changes Type: test data">
        <insert tableName="meta_field_name">
            <column name="id" valueComputed="(select max(t.id)+1 from meta_field_name t)"/>
            <column name="name" value="orderChangeTypeMetaField_1"/>
            <column name="entity_type" value="ORDER_CHANGE"/>
            <column name="data_type" value="STRING"/>
            <column name="is_disabled" valueBoolean="false"/>
            <column name="is_mandatory" valueBoolean="false"/>
            <column name="display_order" valueNumeric="1"/>
            <column name="optlock" valueNumeric="0"/>
            <column name="entity_id" valueNumeric="1"/>
            <column name="is_primary" valueBoolean="true"/>
        </insert>
    </changeSet>

    <changeSet author="Alexander Aksenov" context="base"
               id="20140227 #7520 Order Changes Type plugin for orderStatus change">

        <insert tableName="pluggable_task_type">
            <column name="id" valueComputed="(select max(p.id)+1 from pluggable_task_type p)"/>
            <column name="category_id" valueNumeric="17"/>
            <column name="class_name" value="com.sapienter.jbilling.server.order.task.OrderChangeApplyOrderStatusTask"/>
            <column name="min_parameters" valueNumeric="0"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="24"/>
            <column name="foreign_id" valueComputed="(select max(p.id) from pluggable_task_type p)"/>
            <column name="psudo_column" value="title"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="Change order status on order change apply"/>
        </insert>

        <insert tableName="international_description">
            <column name="table_id" valueNumeric="24"/>
            <column name="foreign_id" valueComputed="(select max(p.id) from pluggable_task_type p)"/>
            <column name="psudo_column" value="description"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content"
                    value="This plug-in will change the status of order during order change apply to selected in order change."/>
        </insert>

        <update tableName="jbilling_seqs">
            <column name="next_id" valueComputed="(select max(p.id)+1 from pluggable_task_type p)"/>
            <where>name='pluggable_task_type'</where>
        </update>

        <sql>
            <![CDATA[
                   INSERT INTO pluggable_task (id, entity_id, type_id, processing_order, optlock)
                   select (select max(p.id)+1 from pluggable_task p) + (select count(*) from entity e2 where e1.id > e2.id and e2.id <> e1.id),
                          e1.id,
                          (select max(p.id) from pluggable_task_type p),
                          1,
                          1
                   from entity e1
                   order by e1.id
               ]]>
        </sql>

        <update tableName="jbilling_seqs">
            <column name="next_id" valueComputed="coalesce((select max(p.id)+1 from pluggable_task p), 1)"/>
            <where>name='pluggable_task'</where>
        </update>
    </changeSet>

    <changeSet id="#7870:fix-product-id-in-route-tables" author="Marco Manzi" context="base" dbms="postgresql">
        <sql splitStatements="false">
            <![CDATA[
                    CREATE function temp_for_fix() RETURNS VOID AS
                     $$
                    DECLARE t record;
                    BEGIN
                        FOR t IN SELECT table_name FROM route LOOP
                            EXECUTE 'ALTER TABLE public.' || quote_ident(t.table_name) || ' ALTER COLUMN product TYPE VARCHAR(50)';
                        END LOOP; END;
                    $$ LANGUAGE plpgsql;
                    SELECT temp_for_fix();
                    DROP function temp_for_fix();
               ]]>
        </sql>
    </changeSet>
    <changeSet author="Vivek Sadh" context="test" id="order change4">
        <insert tableName="order_status">
            <column name="id" valueNumeric="400"/>
            <column name="order_status_flag" valueNumeric="0"/> <!-- INVOICE -->
            <column name="entity_id" valueNumeric="1"/>
        </insert>

        <insert tableName="order_change">
            <column name="id" valueComputed="(select COALESCE(max(oc.id),0)+1 from order_change oc)"/>
            <column name="order_id" valueNumeric="107702"/>
            <column name="item_id" valueNumeric="320100"/>
            <column name="quantity" valueNumeric="1"/>
            <column name="price" valueNumeric="1"/>
            <column name="description" value="CALL 1"/>
            <column name="use_item" valueNumeric="1"/>
            <column name="status_id" valueNumeric="38"/>
            <column name="user_assigned_status_id" valueNumeric="38"/>
            <column name="order_line_id" valueNumeric="207902"/>
            <column name="order_change_type_id" valueNumeric="1"/>
            <column name="order_status_id" valueNumeric="400"/>
            <column name="optlock" valueNumeric="1"/>
            <column name="user_id" valueNumeric="1"/>
            <column name="create_datetime" valueDate="2014-03-26 18:56:32.148+05:30"/>
            <column name="start_date" valueDate="2014-03-26"/>
            <column name="application_date" valueDate="2014-03-26"/>
            <column name="create_datetime" valueDate="2012-06-14T10:38:40.673"/>
        </insert>
        <insert tableName="international_description">
            <column name="table_id" valueNumeric="20"/>
            <column name="foreign_id" valueNumeric="400"/>
            <column name="psudo_column" value="description"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="Test"/>
        </insert>
        <update tableName="jbilling_seqs">
            <column name="next_id" valueComputed="(select COALESCE(max(oc.id),0)+1 from order_change oc)" >
            </column>
            <where>name='order_change'</where>
        </update>
    </changeSet>
    
    <changeSet author="Khobab Chaudhary" context="base" id="#7899 - Subscription Products">
        <insert tableName="order_line_type">
        	<column name="id"  valueNumeric="5"/>
            <column name="editable" valueNumeric="1"/>
        </insert>
       
       <insert tableName="international_description">
            <column name="table_id" valueComputed="(select id from jbilling_table where name = 'order_line_type')"/>
            <column name="foreign_id" valueNumeric="5"/>
            <column name="psudo_column" value="description"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="Subscription"/>
        </insert>
    </changeSet>

    <changeSet id="#8330:reassign_the_same_asset_for_terminated_order" author="Marco Manzi" dbms="PostgreSql,MS-SQL,Oracle,MariaDB, MySQL">
        <addColumn tableName="asset_transition">
            <column name="start_date" type="java.sql.Types.TIMESTAMP"/>
        </addColumn>
        <addColumn tableName="asset_transition">
            <column name="end_date" type="java.sql.Types.TIMESTAMP"/>
        </addColumn>
        <addColumn tableName="asset_transition">
            <column name="order_line_id" type="java.sql.Types.INTEGER" />
        </addColumn>

        <sql>
            <!-- Finds all the applied order changes that contain assets
                and create asset_transition records for those asset
                to mark them as taken. So that other orders can not
                take those assets, and moreover to track the starting of
                those assets -->
            <![CDATA[
                insert into asset_transition
                (id, create_datetime, start_date, asset_id, user_id, new_status_id, order_line_id)
                (select tmp.at_id, tmp.create_datetime, tmp.start_date, tmp.asset_id, tmp.user_id, tmp.status_id, tmp.order_line_id
                from
                (select (select coalesce(max(id),0)+a.id from asset_transition ) as at_id,
                    coalesce(
                        (select oc.application_date
                            from order_change oc
                            where oc.application_date is not null
                                and oc.status_id in (select gs.id from generic_status gs where gs.dtype='order_change_status' and attribute1='YES'))
                        ,
                        (select oc.application_date
                            from order_change oc
                            inner join order_change_asset_map ocam on oc.id = ocam.order_change_id
                            where ocam.asset_id = a.id
                                and oc.status_id in (select gs.id from generic_status gs where gs.dtype='order_change_status' and attribute1='YES'))
                    ) as create_datetime,
                    coalesce(
                        (select oc.application_date
                            from order_change oc
                            where oc.application_date is not null
                                and oc.status_id in (select gs.id from generic_status gs where gs.dtype='order_change_status' and attribute1='YES'))
                        ,
                        (select oc.application_date
                            from order_change oc
                            inner join order_change_asset_map ocam on oc.id = ocam.order_change_id
                            where ocam.asset_id = a.id
                                and oc.status_id in (select gs.id from generic_status gs where gs.dtype='order_change_status' and attribute1='YES'))
                    ) as start_date,
                    (a.id) as asset_id,
                    (select o.user_id from purchase_order o where exists (select * from order_line ol where ol.order_id = o.id and ol.id = a.order_line_id)) as user_id,
                    (a.status_id) as status_id,
                    (a.order_line_id) as order_line_id
                from asset a where order_line_id is not null) as tmp
                where tmp.create_datetime is not null
                    and tmp.start_date is not null);
            ]]>
        </sql>
        <dropForeignKeyConstraint constraintName="asset_fk_2" baseTableName="asset" />
        <dropColumn tableName="asset" columnName="order_line_id"/>
    </changeSet>
    
    <changeSet id="#8330:reassign_the_same_asset_for_terminated_order" author="Marco Manzi" dbms="hsqldb,h2">
        <addColumn tableName="asset_transition">
            <column name="start_date" type="java.sql.Types.TIMESTAMP"/>
        </addColumn>
        <addColumn tableName="asset_transition">
            <column name="end_date" type="java.sql.Types.TIMESTAMP"/>
        </addColumn>
        <addColumn tableName="asset_transition">
            <column name="order_line_id" type="java.sql.Types.INTEGER" />
        </addColumn>

        <sql>
            <!-- Finds all the applied order changes that contain assets
                and create asset_transition records for those asset
                to mark them as taken. So that other orders can not
                take those assets, and moreover to track the starting of
                those assets -->
            <![CDATA[
                insert into asset_transition
                (id, create_datetime, start_date, asset_id, user_id, new_status_id, order_line_id)
                (select tmp.at_id, tmp.create_datetime, tmp.start_date, tmp.asset_id, tmp.user_id, tmp.status_id, tmp.order_line_id
                from
                (select (select coalesce(max(id),0)+1 from asset_transition ) as at_id,
                    coalesce(
                        (select oc.application_date
                            from order_change oc
                            where oc.application_date is not null
                                and oc.status_id in (select gs.id from generic_status gs where gs.dtype='order_change_status' and attribute1='YES'))
                        ,
                        (select oc.application_date
                            from order_change oc
                            inner join order_change_asset_map ocam on oc.id = ocam.order_change_id
                            where ocam.asset_id = a.id
                                and oc.status_id in (select gs.id from generic_status gs where gs.dtype='order_change_status' and attribute1='YES'))
                    ) as create_datetime,
                    coalesce(
                        (select oc.application_date
                            from order_change oc
                            where oc.application_date is not null
                                and oc.status_id in (select gs.id from generic_status gs where gs.dtype='order_change_status' and attribute1='YES'))
                        ,
                        (select oc.application_date
                            from order_change oc
                            inner join order_change_asset_map ocam on oc.id = ocam.order_change_id
                            where ocam.asset_id = a.id
                                and oc.status_id in (select gs.id from generic_status gs where gs.dtype='order_change_status' and attribute1='YES'))
                    ) as start_date,
                    (a.id) as asset_id,
                    (select o.user_id from purchase_order o where exists (select * from order_line ol where ol.order_id = o.id and ol.id = a.order_line_id)) as user_id,
                    (a.status_id) as status_id,
                    (a.order_line_id) as order_line_id
                from asset a where order_line_id is not null) as tmp
                where tmp.create_datetime is not null
                    and tmp.start_date is not null);
            ]]>
        </sql>
        <dropForeignKeyConstraint constraintName="asset_fk_2" baseTableName="asset" />
        <dropColumn tableName="asset" columnName="order_line_id"/>
    </changeSet>

    <changeSet id="#8330:start_date_not_null" context="base" author="Marco Manzi">
        <addNotNullConstraint tableName="asset_transition" columnDataType="java.sql.Types.DATE" columnName="start_date"/>
    </changeSet>

    <changeSet id="#8330:asset_transition_seqs" context="base" author="Marco Manzi">
        <update tableName="jbilling_seqs">
            <column name="next_id" valueComputed="(SELECT coalesce(max(id),0) FROM asset_transition)" >
            </column>
            <where>name='asset_transition'</where>
        </update>
    </changeSet>

    <changeSet author="Gerhard Maree" context="base" id="20140131-7219-save-nested-search-entities">
        <createTable tableName="data_table_query_entry">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="route_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="columns" type="varchar(250)">
                <constraints nullable="false"/>
            </column>
            <column name="next_entry_id" type="java.sql.Types.INTEGER" />
            <column name="optlock" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="data_table_query_entry_next_FK"
                                 baseTableName="data_table_query_entry" baseColumnNames="next_entry_id"
                                 referencedTableName="data_table_query_entry" referencedColumnNames="id"/>
        <insert tableName="jbilling_seqs">
            <column name="name" value="data_table_query_entry"/>
            <column name="next_id" valueComputed="(select COALESCE(max(r.id),0)+1 from data_table_query_entry r)"/>
        </insert>

        <createTable tableName="data_table_query">
            <column name="id" type="int">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(50)" >
                <constraints nullable="false"/>
            </column>
            <column name="route_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="global" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="root_entry_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="optlock" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="data_table_query_next_FK"
                                 baseTableName="data_table_query" baseColumnNames="root_entry_id"
                                 referencedTableName="data_table_query_entry" referencedColumnNames="id"/>
        <insert tableName="jbilling_seqs">
            <column name="name" value="data_table_query"/>
            <column name="next_id" valueComputed="(select COALESCE(max(r.id),0)+1 from data_table_query r)"/>
        </insert>

    </changeSet>

    <changeSet id="#7045-data_tables-set_it_as_route_table_or_not" author="Juan Vidal" context="base">
        <addColumn tableName="route">
            <column name="route_table" type="java.sql.Types.BOOLEAN" defaultValueBoolean="false"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#10045:reverting_the_asset_transition_history" author="Marco Manzi">
        <preConditions>
            <columnExists tableName="asset_transition" columnName="order_line_id"/>
        </preConditions>
        <addColumn tableName="asset">
            <column name="order_line_id" type="java.sql.Types.INTEGER"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_line_id"
                                 baseTableName="asset" constraintName="asset_fk_2"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_line"
                                 referencesUniqueColumn="false" />
        <sql>
            <!-- Finds all the applied order changes that contain assets
        and create asset_transition records for those asset
        to mark them as taken. So that other orders can not
        take those assets, and moreover to track the starting of
        those assets -->
            <![CDATA[
                update asset a set order_line_id = (SELECT order_line_id
			from asset_transition where start_date is not null
			AND end_date is null
			AND asset_id = a.id);
            ]]>
        </sql>

        <dropColumn tableName="asset_transition" columnName="start_date"/>
        <dropColumn tableName="asset_transition" columnName="end_date"/>
        <dropColumn tableName="asset_transition" columnName="order_line_id"/>
    </changeSet>
    
    <changeSet id="requirement # 9831 - global assets" author="Rohit Gupta" context="base">
        <addColumn tableName="asset">
            <column defaultValueBoolean="false" name="global" type="java.sql.Types.BOOLEAN">
				<constraints nullable="false"/>
		    </column>
        </addColumn>
        
    	<createTable tableName="asset_entity_map">
        	<column name="asset_id" type="java.sql.Types.INTEGER">
	    		<constraints nullable="false"/>
	    	</column>
            <column name="entity_id" type="java.sql.Types.INTEGER">
 				<constraints nullable="false"/>
 	    	</column>
        </createTable>
        
		<addForeignKeyConstraint baseColumnNames="entity_id"
			baseTableName="asset_entity_map" constraintName="asset_entity_map_fk1"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="entity"
			referencesUniqueColumn="false" />
		<addForeignKeyConstraint baseColumnNames="asset_id"
			baseTableName="asset_entity_map" constraintName="asset_entity_map_fk2"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="asset"
			referencesUniqueColumn="false" />
		<addUniqueConstraint tableName="asset_entity_map"
			columnNames="asset_id, entity_id" constraintName="asset_entity_map_uc_1" />
			
    </changeSet>

	<changeSet author="Aman Goel" context="base" id="20141104-#10343 - entity_id should not be null">
        <addNotNullConstraint columnDataType="java.sql.Types.INTEGER" columnName="entity_id"
                              tableName="item_type"/>
    </changeSet>
	    
	<changeSet id="20141117-jbilling-seqs-correction" author="Vikas Bodani" context="test">
		<update tableName="jbilling_seqs">
			<column name="next_id" valueComputed="(select coalesce( (max(t.id)/100 + 1), 1) from pluggable_task_parameter t)"/>
			<where>name='pluggable_task_parameter'</where>
		</update>
		<update tableName="jbilling_seqs">
			<column name="next_id" valueComputed="(select coalesce( (max(t.id)/10 + 1), 1) from pluggable_task t)"/>
			<where>name='pluggable_task'</where>
		</update>
		<update tableName="jbilling_seqs">
			<column name="next_id" valueComputed="(select coalesce( (max(t.id)/10 + 1), 1) from meta_field_name t)"/>
			<where>name='meta_field_name'</where>
		</update>
		<update tableName="jbilling_seqs">
			<column name="next_id" valueComputed="(select coalesce( (max(t.id)/10 + 1), 1) from meta_field_value t)"/>
			<where>name='meta_field_value'</where>
		</update>
		<update tableName="jbilling_seqs">
			<column name="next_id" valueComputed="(select coalesce( (max(t.id)/10 + 1), 1) from enumeration t)"/>
			<where>name='enumeration'</where>
		</update>
		<update tableName="jbilling_seqs">
			<column name="next_id" valueComputed="(select coalesce( (max(t.id)/10 + 1), 1) from enumeration_values t)"/>
			<where>name='enumeration_values'</where>
		</update>
	</changeSet>
	
	<changeSet id="20141124-rename-partner-to-Agent" author="Vikas Bodani" context="base">
		<validCheckSum>7:4859237ad017f452ef2155abda6b4464</validCheckSum>
		<update tableName="international_description">
			<column name="content" value="Agent"/>
			<where>table_id = (select id from jbilling_table where name ='role') and content='Partner'</where>
		</update>
		<comment>Preference Types 5 through 12 should not being used anywhere. Partner is replaced with Agent.</comment>
		<delete tableName="preference">
			<where>type_id in (5,6,7,8,9,10,11,12)</where>
		</delete>
		<delete tableName="international_description">
			<where>table_id = (select id from jbilling_table where name ='preference_type') and foreign_id in (5,6,7,8,9,10,11,12)</where>
		</delete>
		<delete tableName="preference_type">
			<where>id in (5,6,7,8,9,10,11,12)</where>
		</delete>
		
		<!-- Delete existing notifications Partner Payout & Payout reminder -->
		<delete tableName="notification_message_type">
			<where>category_id = 3 and id in (10,11)</where>
		</delete>
	</changeSet>
	
	<changeSet id="20141126-rename-ForeignKeyConstraint" author="Manisha Gupta" context="base">		   
	    <dropForeignKeyConstraint baseTableName="meta_field_group" constraintName="account_type_main_subscription_period_FK2" />        
		<addForeignKeyConstraint
         constraintName="meta_field_group_account_type_FK2"
         baseTableName="meta_field_group" baseColumnNames="account_type_id"
         referencedTableName="account_type" referencedColumnNames="id"
        />       
		<addForeignKeyConstraint
         constraintName="meta_field_group_entity_FK1"
         baseTableName="meta_field_group" baseColumnNames="entity_id"
         referencedTableName="entity" referencedColumnNames="id"
        />	
	</changeSet>

    <changeSet id="10632-event_base_custom_notification_fix" author="Marco Manzi" context="base">
        <update tableName="pluggable_task_type">
            <column name="min_parameters" value="0"/>
            <where>class_name = 'com.sapienter.jbilling.server.user.tasks.EventBasedCustomNotificationTask' AND category_id = 17</where>
        </update>
    </changeSet>

    <changeSet id="#9977:Partner-To-Agent-Fix-demo-data" author="Marco Manzi">
        <update tableName="international_description">
            <column name="content" value="Create agent"/>
            <where>table_id = 59 AND psudo_column='description' AND foreign_id=101
                AND language_id=1 AND content='Create partner'</where>
        </update>
        <update tableName="international_description">
            <column name="content" value="Create agent"/>
            <where>table_id = 59 AND psudo_column='description' AND foreign_id=101
                AND language_id=1 AND content='Create partner'</where>
        </update>
        <update tableName="international_description">
            <column name="content" value="Edit agent"/>
            <where>table_id = 59 AND psudo_column='description' AND foreign_id=102
                AND language_id=1 AND content='Edit partner'</where>
        </update>
        <update tableName="international_description">
            <column name="content" value="Delete agent"/>
            <where>table_id = 59 AND psudo_column='description' AND foreign_id=103
                AND language_id=1 AND content='Delete partner'</where>
        </update>
        <update tableName="international_description">
            <column name="content" value="View agent details"/>
            <where>table_id = 59 AND psudo_column='description' AND foreign_id=104
                AND language_id=1 AND content='View partner details'</where>
        </update>
        <update tableName="international_description">
            <column name="content" value="A agent that will bring customers"/>
            <where>table_id = 60 AND psudo_column='description' AND foreign_id=4
                AND language_id=1 AND content='A partner that will bring customers'</where>
        </update>
        <update tableName="international_description">
            <column name="content" value="Agent"/>
            <where>table_id = 60 AND psudo_column='title' AND foreign_id=4
                AND language_id=1 AND content='Partner'</where>
        </update>
        <update tableName="international_description">
            <column name="content" value="A agent that will bring customers"/>
            <where>table_id = 60 AND psudo_column='description' AND foreign_id=63
                AND language_id=1 AND content='A partner that will bring customers'</where>
        </update>
        <update tableName="international_description">
            <column name="content" value="Agent"/>
            <where>table_id = 60 AND psudo_column='title' AND foreign_id=63
                AND language_id=1 AND content='Partner'</where>
        </update>
    </changeSet>

    <changeSet id="#10886-init-next-invoice-number-for-child-company" author="Vladimir Carevski" context="test">
         <!--Reseller Organization -->
        <insert tableName="preference">
            <column name="id" valueComputed="(select max(p.id)+1 from preference p)" />
            <column name="table_id" valueComputed="(select p.id from jbilling_table p where p.name = 'entity')" />
            <column name="foreign_id" valueNumeric="3" /> <!--entity id -->
            <column name="type_id" valueNumeric="19" />
            <column name="value" value="1" />
        </insert>

        <update tableName="jbilling_seqs">
            <column name="next_id" valueComputed="(select coalesce( (max(t.id)/10 + 1), 1) from preference t)"/>
            <where>name='preference'</where>
        </update>
    </changeSet>

    <changeSet author="Anand Kushwaha" id="#10901-Replacing Partner to Agents in Permissions page" context="base">
        <update tableName="international_description">
            <column name="content" value="Show agent menu" />
            <where>content='Show partner menu'</where>
        </update>
    </changeSet>

	<changeSet author="Manisha Gupta" context="base" id="Rename MENU_93">
        <update tableName="international_description">
            <column name="content" value="Show payments and refunds menu"/>
            <where>table_id = 59 and foreign_id = 93</where>
        </update>
    </changeSet>

    <changeSet author="Prashant Gupta" context="base" id="#11172-show-category-metafields">
        <createTable tableName="item_type_meta_field_map">
            <column name="item_type_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="meta_field_value_id" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="item_type_id" baseTableName="item_type_meta_field_map"
                                 constraintName="item_type_meta_field_type_fk" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="item_type" referencesUniqueColumn="false"/>

        <addForeignKeyConstraint baseColumnNames="meta_field_value_id" baseTableName="item_type_meta_field_map"
                                 constraintName="item_type_meta_field_value_fk" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="meta_field_value" referencesUniqueColumn="false"/>

    </changeSet>

    <changeSet author="Anand Kushwaha" context="base" id="#10442 Adding All Account TypecheckboxinpaymentMethodType edit">
        <addColumn tableName="payment_method_type" >
            <column name="all_account_type" type="java.sql.Types.BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="20150114 - late guided usage delete order" author="Vikas Bodani" context="base">
        <addColumn tableName="purchase_order">
            <column name="deleted_date" type="java.sql.Types.DATE">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="10915 -create a child company" author="Rohit Gupta" context="test">
    	<insert tableName="entity">
            <column name="id" valueComputed="(select max(e.id)+1 from entity e)"/>
            <column name="external_id"/>
            <column name="description" value="Child Company"/>
            <column name="create_datetime" valueDate="2013-07-12T00:00:00.0"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="currency_id" valueNumeric="1"/>
            <column name="optlock" valueNumeric="1"/>
		    <column name="invoice_as_reseller" valueBoolean="false"/>
		    <column name="parent_id" valueNumeric="1"/>
        </insert>
    </changeSet>

    <changeSet id="11565-added-invoice-reminder-name" author="Prashant Gupta" context="base">
        <preConditions onFail="CONTINUE">
            <sqlCheck expectedResult="0">
                select count(*) from international_description where table_id = 52
                and foreign_id = 18 and language_id = 1 and psudo_column='description'
            </sqlCheck>
        </preConditions>
        <insert tableName="international_description">
            <column name="table_id" valueNumeric="52"/>
            <column name="foreign_id" valueNumeric="18"/>
            <column name="psudo_column" value="description"/>
            <column name="language_id" valueNumeric="1"/>
            <column name="content" value="Invoice Reminder"/>
        </insert>
    </changeSet>

    <changeSet id="#12690-index-on_parent_id-customer-table" author="Prashant Gupta" context="base">
        <!-- create index on customer for column parent_id -->
        <createIndex tableName="customer" indexName="ix_parent_customer_id" unique="false">
            <column name="parent_id"/>
        </createIndex>
    </changeSet>
    
    <changeSet id="#12691-Add field_usage column" author="Ravi Singhal" context="base" dbms="PostgreSql,MS-SQL,Oracle,MariaDB, MySQL">
        <comment>Drop table metafield_type_map. One meta field can have only one usage type.</comment>
        <addColumn tableName="meta_field_name">
            <column name="field_usage" type="java.sql.Types.VARCHAR(50)">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <sql >
            <![CDATA[
             		update meta_field_name as name set field_usage = map.field_usage from metafield_type_map as map where name.id = map.metafield_id ;
               ]]>
        </sql>
    	<dropTable tableName="metafield_type_map"/>
    </changeSet>
    
    <changeSet id="#12691-Add field_usage column" author="Ravi Singhal" context="base" dbms="hsqldb,h2">
        <comment>Drop table metafield_type_map. One meta field can have only one usage type.</comment>
        <addColumn tableName="meta_field_name">
            <column name="field_usage" type="java.sql.Types.VARCHAR(50)">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <sql >
            <![CDATA[
             		update meta_field_name as name set field_usage = (select map.field_usage from metafield_type_map as map where name.id = map.metafield_id );
               ]]>
        </sql>
    	<dropTable tableName="metafield_type_map"/>
    </changeSet>
</databaseChangeLog>
